<script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){

/* ================= FIREBASE ================= */

const firebaseConfig = {  
apiKey: "AIzaSyDtoD3Fa6daF6kHsZHRsXgrLwiyxSQCZZk",  
authDomain: "ble-tag-finder.firebaseapp.com",  
projectId: "ble-tag-finder",  
storageBucket: "ble-tag-finder.firebasestorage.app",  
messagingSenderId: "658694213686",  
appId: "1:658694213686:web:ed81547228034482f44897"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= GLOBAL ================= */

let deviceId = localStorage.getItem("bleDeviceId");
let map = null;
let currentMode = "community";

/* ================= OWNER REGISTER ================= */

window.connectTag = async function(){

currentMode = "owner";

const bleDevice = await navigator.bluetooth.requestDevice({acceptAllDevices:true});
deviceId = bleDevice.id;

localStorage.setItem("bleDeviceId",deviceId);

document.getElementById("deviceName").innerText=bleDevice.name||"Registered Device";
document.getElementById("status").innerText="READY";
document.getElementById("status").className="status-ok";

await db.collection("registeredTags").doc(deviceId).set({
owner:true,
createdAt:Date.now()
});

if(Notification.permission!=="granted"){
await Notification.requestPermission();
}

listenForOwnerAlerts();

alert("Device Registered Successfully!");
}

/* ================= OWNER ALERT ================= */

function listenForOwnerAlerts(){

if(!deviceId) return;

db.collection("detections")
.where("deviceId","==",deviceId)
.onSnapshot(snapshot=>{

snapshot.docChanges().forEach(change=>{

if(change.type==="added"){

if(navigator.vibrate){
navigator.vibrate([300,200,300]);
}

if(Notification.permission==="granted"){
new Notification("Your device was detected by community!");
}

}

});

});
}

/* ================= COMMUNITY ================= */

window.communityScan = async function(){

currentMode = "community";
document.getElementById("map").style.display="none";

const device = await navigator.bluetooth.requestDevice({acceptAllDevices:true});
const detectedId = device.id;

const registered = await db.collection("registeredTags")
.doc(detectedId)
.get();

if(registered.exists){

alert("⚠ This device is registered. Location is protected.");

navigator.geolocation.getCurrentPosition(async(pos)=>{

await db.collection("detections").add({
deviceId: detectedId,
lat: pos.coords.latitude,
lng: pos.coords.longitude,
timestamp: Date.now()
});

},{enableHighAccuracy:true});

return;
}

alert("Device not registered.");

}

/* ================= OWNER MAP ================= */

window.showLocation = async function(){

if(currentMode!=="owner"){
alert("Only owner can view map");
return;
}

const snapshot = await db.collection("detections")
.where("deviceId","==",deviceId)
.get();

if(snapshot.empty){
alert("No detections yet");
return;
}

let points=[];
snapshot.forEach(doc=>points.push(doc.data()));

renderMap(points,false);
}

/* ================= AI ================= */

window.runAI = async function(){

if(currentMode!=="owner"){
alert("Only owner can run AI");
return;
}

const snapshot = await db.collection("detections")
.where("deviceId","==",deviceId)
.get();

if(snapshot.empty){
alert("No detections for AI");
return;
}

let points=[];
snapshot.forEach(doc=>points.push(doc.data()));

renderMap(points,true);
}

/* ================= MAP ================= */

function renderMap(points,runAI){

document.getElementById("map").style.display="block";

if(map){
map.remove();
map=null;
}

map=L.map("map").setView([points[0].lat,points[0].lng],18);

L.tileLayer(
"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
{attribution:"Tiles © Esri"}
).addTo(map);

L.tileLayer(
"https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}"
).addTo(map);

points.forEach(p=>{
L.circleMarker([p.lat,p.lng],{
radius:7,
color:"blue",
fillColor:"#3b82f6",
fillOpacity:1
}).addTo(map);
});

if(runAI){

let avgLat=0,avgLng=0;
points.forEach(p=>{
avgLat+=p.lat;
avgLng+=p.lng;
});
avgLat/=points.length;
avgLng/=points.length;

L.circleMarker([avgLat,avgLng],{
radius:10,
color:"red",
fillColor:"red",
fillOpacity:1
}).addTo(map)
.bindPopup("AI Estimated Location")
.openPopup();

map.setView([avgLat,avgLng],18);
}

setTimeout(()=>map.invalidateSize(),300);
}

});
</script>
